# render.yaml
#
# This configuration file tells Render how to build and deploy your
# Traffic Law AI Assistant. It defines a persistent disk for ChromaDB
# and a web service that uses it.

disks:
  - name: chroma-data
    sizeGB: 1 # Adjust size if your DB grows larger

services:
  # 1. Web Service for the Flask Chatbot
  - type: web
    name: traffic-law-bot
    env: python
    rootDir: traffic_law_bot/chat-bot
    plan: starter_plus # 'starter' might be too slow. 'standard' is also a good option.
    buildCommand: |
      # Install dependencies
      pip install --upgrade pip
      pip install -r requirements.txt

      # Run the data ingestion pipeline. This runs on every deploy.
      # The ChromaDB data will be stored on the persistent disk.
      echo "Running document chunking..."
      python Step1_ingest_traffic_docs.py
      echo "Ingesting data into ChromaDB..."
      python Step2_ingest_to_chroma.py 
    startCommand: "gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120"
    envVars:
      - key: OPENAI_API_KEY
        fromSecret: true # This will prompt you to create a secret in the Render dashboard
      - key: PYTHON_VERSION
        value: 3.12.2 # Match your local Python version
    disk:
      name: chroma-data # Link to the disk defined above
      mountPath: /app/traffic_law_bot/chat-bot/chroma_db